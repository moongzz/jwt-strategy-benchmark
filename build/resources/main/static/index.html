<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JWT 효율성 테스트</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f0f2f5;
            color: #333;
            min-height: 100vh;
        }

        .container {
            background: #fff;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            color: #222;
        }

        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .control-group {
            background: #fafafa;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #e0e0e0;
        }

        .control-group h3 {
            margin: 0 0 15px 0;
            color: #444;
        }

        .input-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }

        input[type="number"], input[type="range"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 16px;
        }

        input[type="number"]:focus, input[type="range"]:focus {
            outline: none;
            border-color: #007bff;
        }

        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: background 0.3s ease;
        }

        button:hover {
            background: #0056b3;
        }

        .results {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 30px;
        }

        .result-card {
            background: #fafafa;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #e0e0e0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .result-card h3 {
            margin: 0 0 15px 0;
            font-size: 1.4em;
            color: #333;
            text-align: center;
        }

        .whitelist {
            border-left: 4px solid #28a745;
        }

        .blacklist {
            border-left: 4px solid #dc3545;
        }

        .metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 8px 10px;
            background: #fff;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
        }

        .metric-value {
            font-weight: bold;
            font-size: 1.1em;
        }

        .chart {
            margin-top: 30px;
            background: #fff;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #e0e0e0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        canvas {
            width: 100%;
            height: 300px;
        }

        .progress {
            width: 100%;
            height: 20px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-bar {
            height: 100%;
            background: #28a745;
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 10px;
        }

        @media (max-width: 768px) {
            .results {
                grid-template-columns: 1fr;
            }

            .controls {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <h1>🔐 JWT 효율성 테스트</h1>

    <div class="controls">
        <div class="control-group">
            <h3>📊 시뮬레이션 설정</h3>
            <div class="input-group">
                <label for="userCount">사용자 수</label>
                <input type="number" id="userCount" value="1000" min="100" max="100000">
            </div>
            <div class="input-group">
                <label for="tokenLifetime">토큰 수명 (초)</label>
                <input type="number" id="tokenLifetime" value="3600" min="300" max="86400">
            </div>
            <div class="input-group">
                <label for="sessionsPerUser">사용자당 세션 수</label>
                <input type="number" id="sessionsPerUser" value="2" min="1" max="10" step="0.1">
            </div>
        </div>

        <div class="control-group">
            <h3>⚙️ 사용자 행동 패턴</h3>
            <div class="input-group">
                <label for="loginRate">시간당 로그인 비율</label>
                <input type="range" id="loginRate" min="0" max="1" step="0.01" value="0.1">
                <span id="loginRateValue">10%</span>
            </div>
            <div class="input-group">
                <label for="logoutRate">시간당 로그아웃 비율</label>
                <input type="range" id="logoutRate" min="0" max="1" step="0.01" value="0.05">
                <span id="logoutRateValue">5%</span>
            </div>
        </div>
    </div>

    <div style="text-align: center;">
        <button onclick="runSimulation()">🚀 시뮬레이션 실행</button>
    </div>

    <div class="progress" id="progressContainer" style="display: none;">
        <div class="progress-bar" id="progressBar"></div>
    </div>

    <div class="results" id="results" style="display: none;">
        <div class="result-card whitelist" id="whitelistCard">
            <h3>📝 화이트리스트</h3>
            <div class="metric">
                <span>활성 토큰 수</span>
                <span class="metric-value" id="whitelistTokens">-</span>
            </div>
            <div class="metric">
                <span>메모리 사용량 (KB)</span>
                <span class="metric-value" id="whitelistMemory">-</span>
            </div>
            <div class="metric">
                <span>검증 시간 (ms)</span>
                <span class="metric-value" id="whitelistTime">-</span>
            </div>
        </div>

        <div class="result-card blacklist" id="blacklistCard">
            <h3>🚫 블랙리스트</h3>
            <div class="metric">
                <span>무효화된 토큰 수</span>
                <span class="metric-value" id="blacklistTokens">-</span>
            </div>
            <div class="metric">
                <span>메모리 사용량 (KB)</span>
                <span class="metric-value" id="blacklistMemory">-</span>
            </div>
            <div class="metric">
                <span>검증 시간 (ms)</span>
                <span class="metric-value" id="blacklistTime">-</span>
            </div>
        </div>
    </div>

    <div class="chart" id="chartContainer" style="display: none;">
        <h3>📈 시간별 토큰 수 변화</h3>
        <canvas id="tokenChart"></canvas>
    </div>
</div>

<script>
    // 슬라이더 값 업데이트
    const updateSliderValue = (id, displayId) => {
        document.getElementById(id).addEventListener('input', function() {
            document.getElementById(displayId).textContent = Math.round(this.value * 100) + '%';
        });
    };

    updateSliderValue('loginRate', 'loginRateValue');
    updateSliderValue('logoutRate', 'logoutRateValue');

    function updateProgress(percent) {
        document.getElementById('progressBar').style.width = percent + '%';
    }

    function drawChart(data) {
        const canvas = document.getElementById('tokenChart');
        if (!data.whitelist || !data.blacklist || !data.timestamps) {
            console.error("❌ Canvas element not found!");
            return;
        }
        const ctx = canvas.getContext('2d');

        // 캔버스 크기 설정
        canvas.width = canvas.offsetWidth || 600;
        canvas.height = 300;

        const width = canvas.width;
        const height = canvas.height;
        const padding = 60;

        // 배경: 하얀색 + 그림자
        ctx.fillStyle = '#fff';
        ctx.shadowColor = 'rgba(0,0,0,0.2)';
        ctx.shadowBlur = 15;
        ctx.fillRect(0, 0, width, height);

        // 그림자 해제 (선과 글자에는 적용하지 않기 위해)
        ctx.shadowColor = 'transparent';

        const maxTokens = Math.max(...data.whitelist, ...data.blacklist);
        const xStep = (width - 2 * padding) / (data.timestamps.length - 1);
        const yScale = (height - 2 * padding) / maxTokens;

        // 격자
        ctx.strokeStyle = '#bbb'; // 회색
        ctx.lineWidth = 1;
        for (let i = 0; i <= 10; i++) {
            const y = padding + (height - 2 * padding) * i / 10;
            ctx.beginPath();
            ctx.moveTo(padding, y);
            ctx.lineTo(width - padding, y);
            ctx.stroke();
        }

        // 화이트리스트 선
        ctx.strokeStyle = '#4ecdc4';
        ctx.lineWidth = 3;
        ctx.beginPath();
        data.whitelist.forEach((value, index) => {
            const x = padding + index * xStep;
            const y = height - padding - value * yScale;
            if (index === 0) ctx.moveTo(x, y);
            else ctx.lineTo(x, y);
        });
        ctx.stroke();

        // 블랙리스트 선
        ctx.strokeStyle = '#ff6b6b';
        ctx.beginPath();
        data.blacklist.forEach((value, index) => {
            const x = padding + index * xStep;
            const y = height - padding - value * yScale;
            if (index === 0) ctx.moveTo(x, y);
            else ctx.lineTo(x, y);
        });
        ctx.stroke();

        // 범례
        // 화이트리스트
        ctx.fillStyle = '#4ecdc4';
        ctx.fillRect(width - 200, 20, 20, 10);
        ctx.fillStyle = '#000'; // 검정색 글씨
        ctx.font = 'bold 14px Arial';
        ctx.fillText('화이트리스트', width - 170, 30);

        // 블랙리스트
        ctx.fillStyle = '#ff6b6b';
        ctx.fillRect(width - 200, 40, 20, 10);
        ctx.fillStyle = '#000'; // 검정색 글씨
        ctx.fillText('블랙리스트', width - 170, 50);
    }

    async function runSimulation() {
        const progressContainer = document.getElementById('progressContainer');
        const results = document.getElementById('results');
        const chartContainer = document.getElementById('chartContainer');

        progressContainer.style.display = 'block';
        results.style.display = 'none';
        chartContainer.style.display = 'none';

        const requestBody = {
            userCount: parseInt(document.getElementById('userCount').value),
            tokenLifetime: parseInt(document.getElementById('tokenLifetime').value),
            sessionsPerUser: parseFloat(document.getElementById('sessionsPerUser').value),
            loginRate: parseFloat(document.getElementById('loginRate').value),
            logoutRate: parseFloat(document.getElementById('logoutRate').value),
        };

        // 단순 진행률 애니메이션
        for (let progress = 0; progress <= 50; progress += 10) {
            updateProgress(progress);
            await new Promise(resolve => setTimeout(resolve, 50));
        }

        try {
            const response = await fetch('/api/simulation', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestBody)
            });

            const data = await response.json();
            updateProgress(100);

            // 결과 표시
            document.getElementById('whitelistTokens').textContent = data.whitelistCounts.at(-1).toLocaleString();
            document.getElementById('blacklistTokens').textContent = data.blacklistCounts.at(-1).toLocaleString();

            document.getElementById('whitelistMemory').textContent = data.metrics.whitelistMemoryKB.toLocaleString();
            document.getElementById('whitelistTime').textContent = data.metrics.whitelistTime.toFixed(2);

            document.getElementById('blacklistMemory').textContent = data.metrics.blacklistMemoryKB.toLocaleString();
            document.getElementById('blacklistTime').textContent = data.metrics.blacklistTime.toFixed(2);

            drawChart({
                whitelist: data.whitelistCounts,
                blacklist: data.blacklistCounts,
                timestamps: data.timestamps
            });

            progressContainer.style.display = 'none';
            results.style.display = 'grid';
            chartContainer.style.display = 'block';
        } catch (err) {
            console.error('시뮬레이션 실패', err);
            alert('시뮬레이션 실행 중 오류가 발생했습니다.');
            progressContainer.style.display = 'none';
        }
    }

    // 초기 슬라이더 값
    document.getElementById('loginRateValue').textContent = '10%';
    document.getElementById('logoutRateValue').textContent = '5%';
</script>
</body>
</html>
